<VirtualHost *:80>
  DocumentRoot /var/www/html

  <Directory "/usr/lib/cgi-bin">
    AllowOverride None
    Require all granted
    SetHandler fcgid-script
  </Directory>

  ## Logging
  ErrorLog "${APACHE_LOG_DIR}/mapserver-default_error.log"
  ServerSignature Off
  CustomLog "${APACHE_LOG_DIR}/mapserver-default_access.log" combined
  ## Rewrite rules
  RewriteEngine On

  ###
  # If a wms request comes in which specifies a either a CRS or SRS parameter and the value of
  # that parameter is prefixed 'EPSG:' then we will process the map request from a mapfile optimised
  # for the specifed projections system. These are stored in the /maps directory with filenames in
  # the following format:
  #     /maps/METADATADOCUMENTID-27700.map
  #     /maps/METADATADOCUMENTID-3857.map
  ###
  RewriteCond %{QUERY_STRING} (?:^|&)(?:C|S)RS=EPSG(?::|%3A)([^&]+)
  RewriteRule .* - [E=EPSG:%1]
  RewriteCond /mapserver/maps/%{REQUEST_FILENAME}_%{ENV:EPSG}.map -f
  RewriteRule ^/(.*)$ /cgi-bin/mapserv?map=/mapserver/maps/$1_%{ENV:EPSG}.map [QSA,L,NC,PT]

  ## Fallback to METADATADOCUMENTID_default.map (if present)
  RewriteCond /mapserver/maps/%{REQUEST_FILENAME}_default.map -f
  RewriteRule ^/(.*)$ /cgi-bin/mapserv?map=/mapserver/maps/$1_default.map [QSA,L,NC,PT]

  ## Script alias directives
  ScriptAlias /cgi-bin "/usr/lib/cgi-bin/"
</VirtualHost>